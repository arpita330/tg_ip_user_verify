<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secure Network Verification</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="margin:0;background:#0f172a;color:white;font-family:Arial;display:flex;justify-content:center;align-items:center;height:100vh;">

<div style="text-align:center;width:90%;max-width:400px;">
    <h2 id="title">üîç Scanning Network</h2>
    <p id="status">Initializing security...</p>
    <p id="percent">0%</p>
</div>

<script>

const tg = window.Telegram.WebApp;
tg.expand();

let percent = document.getElementById("percent");
let title = document.getElementById("title");
let statusText = document.getElementById("status");

let value = 0;

let interval = setInterval(()=>{
    value += 5;
    percent.innerText = value + "%";

    if(value >= 100){
        clearInterval(interval);
        verifyBackend();
    }
},150);

// üîê Canvas Fingerprint
function getCanvasFingerprint() {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    ctx.textBaseline = "top";
    ctx.font = "14px Arial";
    ctx.fillText("secure_fingerprint", 2, 2);
    return canvas.toDataURL();
}

// üîê WebGL Fingerprint
function getWebGLFingerprint() {
    const canvas = document.createElement("canvas");
    const gl = canvas.getContext("webgl");
    if (!gl) return "no_webgl";
    const debugInfo = gl.getExtension("WEBGL_debug_renderer_info");
    return debugInfo
        ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
        : "unknown";
}

async function verifyBackend(){

    if (!tg.initData) {
        title.innerText = "‚ùå Invalid Access";
        statusText.innerText = "Open from Telegram.";
        return;
    }

    const fingerprint = {
        screen: screen.width + "x" + screen.height,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        cpu: navigator.hardwareConcurrency || 0,
        memory: navigator.deviceMemory || 0,
        canvas: getCanvasFingerprint(),
        webgl: getWebGLFingerprint()
    };

    const response = await fetch("/api/verify",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            initData: tg.initData,
            fingerprint: fingerprint
        })
    });

    const data = await response.json();

    if(data.status === "verified"){

        title.innerText = "‚úÖ Verified Successfully";
        statusText.innerText = "Device secured.";

        tg.sendData(JSON.stringify({ status: "verified" }));

    } 
    else if(data.status === "multi_account_blocked"){

        title.innerText = "‚ùå Multiple Accounts Detected";
        statusText.innerText = "This device/network is locked.";

    } 
    else {

        title.innerText = "‚ùå Verification Failed";
        statusText.innerText = "Security validation failed.";

    }
}

</script>

</body>
</html>
